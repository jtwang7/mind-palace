# 基于观察者模式理解 rc-field-form 源码

参考:

- [rc-field-form](https://github.com/react-component/field-form)
- [深入学习并手写 React Ant Design4 表单核心库 rc-field-form](https://juejin.cn/post/6922595635396870152#heading-10)
- [探索 rc-field-form 性能的极限](https://juejin.cn/post/7204356282589511740)
- [模仿antd4从零到一实现rc-field-form](https://juejin.cn/post/6897038502517555207)
- [观察者模式实践](https://github.com/jtwang7/mind-palace/blob/main/notes/%5B%E9%80%9A%E7%94%A8%5D%20%E8%A7%82%E5%AF%9F%E8%80%85%E6%A8%A1%E5%BC%8F%E5%AE%9E%E8%B7%B5/README.md)

## rc-field-form

rc-field-form 是 antd Form 的基础表单库，其设计理念经过多版本的迭代和锤炼，已经相对成熟。相比于 antd3.x 时期的 Form 表单结构而言，antd4.x 及其后续版本无论是在性能、功能还是调用方式等方面都有了更加成熟的解决方案。通过研究 antd4.x 及其后续版本的基础表单库 rc-field-form 源码，可以帮助我们更加深刻的理解 Form 表单的架构、表单组件的性能优化方案等。

### 从观察者模式角度理解 rc-field-form 设计理念

Form 表单的一大作用是统筹管理分散在内部各处的控件逻辑和状态。当我们用 React 设计 Form 表单的时候，最容易想到的就是类似 Redux 的全局状态管理，将所有控件状态提升至顶层组件中进行全局的状态管理，在状态发生改变时触发整个表单的重渲染。

自顶向下的类 Redux 模式，虽然能够收集零散的控件信息，方便管理控件状态和组件间联动更新，但是在大型表单应用场景下的性能表现却不尽人意。由于全局状态被保存在了顶层组件，因此全局状态的更新会触发 Form Root 的重渲染，进而导致所有子组件的重渲染，产生了极大的性能开销 (尤其是在大型表单应用中，用户感知尤为明显)。产生上述问题的根本原因在于 React 的单向数据流以及其组件渲染机制:

1. 单向数据流推崇将公共的数据提取到上层公共组件中进行管理保存。在表单结构中，内部控件间的联动通常是兄弟组件关系，若各控件分别管理自身的状态，同时又要兼顾与其他内部控件间的联动效果，那么逻辑会过于分散，增大维护成本。因此，将状态保存至他们的上层公共容器中是正确的做法。
2. React 组件重渲染时，会卸载掉其所有的子组件并重新创建它们。一般场景下，这往往是高效的做法，但是对于全局管理子组件状态的表单结构而言，个别子组件状态的频繁更新，会不断触发顶层根组件的重渲染，导致其内部所有子组件的重渲染。虽然根组件的重渲染能够简单粗暴的实现整个表单的视图更新，但对于大型应用场景而言，会造成可感知的性能开销。

针对上述性能问题，目前有几套解决方案:

1. 内部组件级别的状态管理与更新: 将状态分散到各个控件内部进行各自管理与更新，避免了根组件的重渲染。但该方法将逻辑都定义在了各个表单控件中，不方便内部控件间的逻辑联动以及后续的管理与维护。
2. 利用 shouldComponentUpdate 或 React.memo 等方法避免更新未发生变动的内部控件。该方法可以在一定程度上解决重渲染 Form Root Component 导致未变动的内部控件也跟随渲染的问题，避免无效的性能开销，但是需要为每个内部控件定制触发更新的依赖，开发过程相对繁琐。
3. 观察者模式: 观察者模式定义了一个顶层容器专门存储全局状态与订阅列表，并提供了添加订阅的接口。表单内部控件则被视为观察者，通过将自身实例添加到订阅列表，与顶层容器实现松耦合关系。顶层容器维护全局的公共逻辑和状态，在状态更新或公共逻辑执行时，调用表单内部控件预先提供的方法，通知表单控件执行预定义的操作(通常是控件级别的重渲染，保证视图同步)。

> 突发奇想：是否能够利用 React key 标记各内部控件的唯一性，通过尽可能地复用内部控件减少重渲染，从而达到性能优化的目的？

分析和对比上述解决方案，本文认为借助观察者模式实现基于 React 技术栈的表单组件更优。它实现状态全局管理的同时，还保证了内部组件级别的更新。实现基于观察者模式的 React 表单组件，我们需要完成以下几个基本单元:

1. useForm: 创建和管理表单顶层容器单例的 React hook。每个表单组件有且仅维护一个顶层容器实例，该顶层容器不涉及任何视图元素，因此用 ES6 类创建即可。顶层容器中需要包含:
   1. 

### useForm

### Field

### Form

### 小结

## 简易 rc-field-form 表单实现

### useForm

### Field

### Form

### 小结

## 性能测试

## 总结